name: PR Emoji & Notion Update by Author

on:
  pull_request:
    types: [opened, edited, reopened]

jobs:
  update-notion-checkbox:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title and body, then update author-specific checkbox
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          echo "ğŸ” ì‹œì‘: PR ì œëª©ê³¼ ë³¸ë¬¸ í™•ì¸"

          PR_TITLE=$(jq -r .pull_request.title "$GITHUB_EVENT_PATH")
          PR_BODY=$(jq -r .pull_request.body "$GITHUB_EVENT_PATH")
          PR_AUTHOR=$(jq -r .pull_request.user.login "$GITHUB_EVENT_PATH")

          echo "ğŸ“Œ PR Title: $PR_TITLE"
          # echo "ğŸ“ PR Body: $PR_BODY"
          echo "ğŸ‘¤ ì‘ì„±ì: $PR_AUTHOR"

          # âœ… ë° âŒ ì´ëª¨ì§€ ê°ì§€
          HAS_CHECK=$(echo "$PR_BODY" | grep -q "âœ…" && echo "yes" || echo "no")
          HAS_CROSS=$(echo "$PR_BODY" | grep -q "âŒ" && echo "yes" || echo "no")

          if [[ "$HAS_CHECK" == "yes" && "$HAS_CROSS" == "yes" ]]; then
            CHECKBOX_VALUE=false
            echo "âš ï¸ ë‘˜ ë‹¤ í¬í•¨ â†’ false"
          elif [[ "$HAS_CROSS" == "yes" ]]; then
            CHECKBOX_VALUE=false
            echo "âŒ í¬í•¨ â†’ false"
          elif [[ "$HAS_CHECK" == "yes" ]]; then
            CHECKBOX_VALUE=true
            echo "âœ… í¬í•¨ â†’ true"
          else
            echo "âš ï¸ ì´ëª¨ì§€ê°€ ì—†ì–´ ìŠ¤í‚µí•©ë‹ˆë‹¤."
            exit 0
          fi

          # ì‘ì„±ì â†’ ì²´í¬ë°•ìŠ¤ í•„ë“œ ë§¤í•‘
          case "$PR_AUTHOR" in
            "Eunjin3395") FIELD_NAME="ì€ì§„" ;;
            "rimi3226") FIELD_NAME="íš¨ë¦¼" ;;
            "KII1ua") FIELD_NAME="ì„±ìœ¤" ;;
            "kslvy") FIELD_NAME="ê²½ì€" ;;
            *)
              echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì‘ì„±ì: $PR_AUTHOR"
              exit 1
              ;;
          esac

          echo "ğŸ§© ì ìš© ëŒ€ìƒ í•„ë“œ: $FIELD_NAME"

          # PR ì œëª©ì—ì„œ BOJ ë¬¸ì œ ë²ˆí˜¸ ì¶”ì¶œ
          PROBLEM_NO=$(echo "$PR_TITLE" | grep -oE '\[BOJ [0-9]+\]' | grep -oE '[0-9]+')
          if [ -z "$PROBLEM_NO" ]; then
            echo "âŒ PR ì œëª©ì—ì„œ ë¬¸ì œ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "ğŸ”¢ ì¶”ì¶œëœ ë¬¸ì œ ë²ˆí˜¸: $PROBLEM_NO"

          # Notion DBì—ì„œ ì œëª© == ë¬¸ì œ ë²ˆí˜¸ì¸ í˜ì´ì§€ ê²€ìƒ‰
          SEARCH_RESULT=$(curl -s -X POST "https://api.notion.com/v1/databases/$NOTION_DATABASE_ID/query" \
            -H "Authorization: Bearer $NOTION_API_KEY" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            --data '{
              "filter": {
                "property": "ë¬¸ì œ ë²ˆí˜¸",
                "title": {
                  "equals": "'"$PROBLEM_NO"'"
                }
              }
            }')

          PAGE_ID=$(echo "$SEARCH_RESULT" | jq -r '.results[0].id')

          if [ "$PAGE_ID" = "null" ] || [ -z "$PAGE_ID" ]; then
            echo "âŒ Notionì—ì„œ ì œëª©ì´ $PROBLEM_NOì¸ í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "âœ… ëŒ€ìƒ Notion í˜ì´ì§€ ID: $PAGE_ID"

          # ì‘ì„±ìì— ë”°ë¼ í•´ë‹¹ í•„ë“œ ì²´í¬ë°•ìŠ¤ë§Œ ì—…ë°ì´íŠ¸
          curl -X PATCH "https://api.notion.com/v1/pages/$PAGE_ID" \
            -H "Authorization: Bearer $NOTION_API_KEY" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            --data '{
              "properties": {
                "'"$FIELD_NAME"'": {
                  "checkbox": '"$CHECKBOX_VALUE"'
                }
              }
            }'

          echo "ğŸ‰ Notion ì—…ë°ì´íŠ¸ ì™„ë£Œ: $FIELD_NAME â†’ $CHECKBOX_VALUE"
